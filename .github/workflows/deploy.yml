name: Deploy Hubbly API

on:
  push:
    branches: [ master, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Hubbly.Api/Hubbly.Api.csproj
    
    - name: Build
      run: dotnet build Hubbly.Api/Hubbly.Api.csproj --configuration Release --no-restore
    
    - name: Publish project
      run: |
        # ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        dotnet publish Hubbly.Api/Hubbly.Api.csproj \
          --configuration Release \
          --output ./publish \
          --no-build \
          --no-restore
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ three_scene.html Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ
        if [ -f "./publish/wwwroot/three_scene.html" ]; then
          echo "âœ… three_scene.html is present"
        else
          echo "âŒ three_scene.html MISSING!"
          exit 1
        fi
    
    - name: Create tar archive
      run: |
        cd publish
        tar -czf ../publish.tar.gz .
        cd ..
    
    - name: Copy to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "publish.tar.gz"
        target: "/tmp"
    
    - name: Deploy on server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e  # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ÑÑ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
          
          echo "ğŸš€ Starting deployment..."
          
          # 1. Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
          echo "ğŸ“¦ Extracting files..."
          rm -rf /opt/hubbly-publish-new
          mkdir -p /opt/hubbly-publish-new
          tar -xzf /tmp/publish.tar.gz -C /opt/hubbly-publish-new
          rm /tmp/publish.tar.gz
          
          # 2. Ğ¡ĞĞ¥Ğ ĞĞĞ¯Ğ•Ğœ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ wwwroot (Ñ„Ğ°Ğ¹Ğ»Ñ‹, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºÑƒ)
          echo "ğŸ’¾ Preserving existing wwwroot files..."
          if [ -d "/opt/hubbly-publish/wwwroot/avatars" ]; then
            mkdir -p /opt/hubbly-publish-new/wwwroot
            cp -r /opt/hubbly-publish/wwwroot/avatars /opt/hubbly-publish-new/wwwroot/ 2>/dev/null || true
            cp -r /opt/hubbly-publish/wwwroot/animations /opt/hubbly-publish-new/wwwroot/ 2>/dev/null || true
          fi
          
          # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ three_scene.html
          if [ ! -f "/opt/hubbly-publish-new/wwwroot/three_scene.html" ]; then
            echo "âŒ ERROR: three_scene.html missing in new version!"
            exit 1
          fi
          
          # 4. ĞœĞµĞ½ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ°Ğ¼Ğ¸ (blue-green deployment)
          echo "ğŸ”„ Switching versions..."
          rm -rf /opt/hubbly-publish-old
          mv /opt/hubbly-publish /opt/hubbly-publish-old 2>/dev/null || true
          mv /opt/hubbly-publish-new /opt/hubbly-publish
          
          # 5. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ
          echo "ğŸ”„ Restarting service..."
          systemctl restart hubbly
          sleep 5
          
          # 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Service status:"
          systemctl status hubbly --no-pager
          
          echo "âœ… Deployment completed successfully!"